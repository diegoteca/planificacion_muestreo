---
title: "Azar simple"
---

## Porqué usamos el azar para producir muestras (aproximadamente) representativas

Si ser muy profundos en cuanto a la teoría del muestreo o en cuanto a su justificación más académica en lo que sigue se intenta recordar que sucede si se realizan muestras aleatorias dentro de una población. Para eso vamos a simular que hacemos muchas muestras aleatorias simples sobre una población imaginaria. Primero haremos, o más bien repetiremos, muestras relativamente pequeñas y luego haremos muestras algo más grandes.

Para tener una mejor experiencia de este simulador es aconsejable su ejecución a través de este [link](https://planificacion-muestreo.netlify.app/simulador_teorema_limite_central.html).

<iframe width="100%" height="500" src="https://diegoteca.com.ar/SimuladorTeoremaLimiteCentral.html" title="Webpage example">

</iframe>

Con este programa podemos jugar de varias formas. Aquí nos interesa las siguientes.

1.  En primer lugar ver que pasa, en los términos de la figura "datos acumulativos de las muestras" cuando realizamos muchas muestras sobre una misma población (p.e. Población = "Opción 3"). Como veremos, estas distribuciones, en especial si la muestra contiene más de 30 casos, converge hacia un patrón de distribución "normal". Lo interesante es que esta distribución emerge con mayor o menor rapidez, de manera independiente de la forma de la población. Esto se puede probar escogiendo diferente poblaciones (p.e. Tamaño de la muestra = 30 y 200).

2.  Por otro lado se puede probar que sucede si, se hace el ejercicio anterior en diferentes poblaciones (p.e. con Población = "Opción 6"). Como se observará siempre se obtiene una distribución "normal" aunque en mayor tiempo y con una diferente varianza.

## Población

Como se dijo anteriormente, nuestra **población** será una población de establecimientos educativos de gestión estatal de nivel primario. Cada uno de los integrantes de esta población se pueden considerar como **unidades de selección**, el subconjunto finalmente seleccionado será la **muestra** y la cantidad de los miembros seleccionados será el **tamaño de la muestra**. En este caso, como se observa en @tbl-escuelas, se tiene información variada sobre cada una de las escuelas. Como veremos más adelante, tener más información sobre las unidades de selección puede ayudar para la efectiva realización de diferentes diseños muestrales.

```{r}
#| label: setting

# Hay que instalar las siguientes librerias previamente sino las tienen instaladas

library(here)
library(readxl)
library(janitor)
library(tidyverse)
library(gt)
library(sampling)
library(gtsummary)
library(infer)
library(patchwork)
library(srvyr)
library(survey)

i_am("azar.qmd")

theme_gtsummary_language(
language = "es",
decimal.mark = ",",
big.mark = ".")
```

```{r}
#| label: tbl-escuelas
#| tbl-cap: Información de las escuelas

base = read_xlsx(here("Inputs", "base_escuelas_primaria.xlsx")) |>
clean_names() |>
mutate(ambito = as_factor(ambito),
       region = as_factor(region))

# Le agrego las coordenadas de los colegios


base |>
slice_head(n = 3) |>
gt()
```

Como puede observarse se trata de una base de escuelas en el sentido que en cada fila hay un establecimiento diferente que contiene una serie de propiedades de los mismos en cada una de las columnas. Algunas de esas propiedades se podrían considerar como intrínsecas de cada escuela (clave, región, ámbito, etc.), otras pueden considerarse como propiedades agregadas de los establecimientos en el sentido que devienen de agregaciones de los estudiantes que son parte de cada escuela (prueba_x) o de los directivos de los mismos (direct_x). Esta distinciones son importantes cuando se quiere realizar una muestra porque esto indica límites y posibilidades sobre a qué población se puede realizar una "buena" muestra desde este archivo. En este contexto, la información de este archivo es particularmente buena para realizar una muestra de colegios pero quizá no tan apropiada para realizar una muestra de estudiantes o directivos...al menos si se lo compara, respectivamente, con tener acceso a lista de estudiantes o directivos con el agregado del dato de la escuela. Como veremos más adelante, si se tiene en mente este último punto es posible minimizar algunos de esos problemas aplicando algunas estrategias (p.e. seleccionar pocos estudiantes de cada colegio seleccionado).[^azar-1]

Por ahora trabajaremos con este archivo para realizar diferentes tipos de muestras de establecimientos educativos. Un plus pedagógico de esta estrategia es que vamos a tener a mano los valores de las estimaciones de las diferentes muestras que se vayan realizando y los respectivos valores de los parámetros poblaciones para comparar resultados. Algunos de esos valores poblacionales se podrá considerar como información secundaria en el sentido que el interés de la muestra no es estimar esos parámetros. Otros de esos valores se los podrá considerar como los parámetros a estimar en la muestra. Esta última situación no es la usual porque si ya se tiene el parámetro poblacional no es necesario la realización de una muestra para su estimación.

Dentro de los parámetros poblacionales vamos a calcular los siguientes:

-   Matrícula

-   Secciones

-   Sondeo primero

-   Sondeo segundo

-   Región

-   Ámbito

Algunas de las variables anteriores son categóricas (región, ámbito) y otras no. Vamos a ver que esto importa porque no es lo mismo estimar un parámetro continuo que uno categórico. Dentro de estos últimos tampoco es lo mismo estimar una variable con 25 categorías (p.e. región) que una variable categórica de 3 categorías (p.e. ámbito).

En la @tbl-parametros_base puede observarse algunos de los valores de estos parámetros. Para el caso de las variables continuas (Matrícula, Secciones, sondeo primero, sondeo segundo) se ha calculado la media junto con los valores del primer y tercer cuartil. En el caso de las variables categóricas (región, ámbito) se han calculado los respectivos porcentajes de cada categoría. Esta distinción es importante porque mientras algunas muestras se esfuerzan por estimar medidas de tendencia central, otras se esfuerzan por estimar medidas de dispersión central y otras intentan hacer ambos tipos de estimaciones.

```{r}
#| label: tbl-parametros_base
#| tbl-cap: Valores poblacionales de las escuelas

base_toy = base |>
select(clave, matricula, secciones, sondeo_primero, sondeo_segundo, region, ambito) 
pob_param = base_toy |>
tbl_summary(include = !clave,
            statistic = list(
      all_continuous() ~ "{mean} ({p25}, {p75})"))

pob_param
```

Estos parámetros "conocidos" van a tener 2 funciones en este taller. Por un lado nos van a servir para cotejar *ex-ante* las distintas estimaciones de los diferentes diseños muestrales que vamos a usar y, por otro lado, nos pueden servir, *ex-post*, para mejorar las muestras concretas efectivamente obtenidas. Esto último, más allá de las técnicas específicas que se utilicen, es importante por lo siguiente:

Las muestras que se hacen en la realidad son "únicas" o "individuales" en el sentido que no se repiten. Esto quiere decir que, si bien la teoría de muestreo derivada de la aleatoriedad muchas veces supone una distribución de muestras (como las simulaciones anteriores en donde se realizaban varias muestras de una misma población) en la realidad el investigador que sale a campo muchas veces dispone de sólo una muestra y el objetivo es que "esa" muestra (y no cualquier otra posible) sea de las mejores y no de las peores. En este sentido, es útil tener herramientas que permitan saber si la muestra es de las buenas o de las malas y, si se trata del segundo caso, como mejorarlas.

## Azar simple

Dentro de los métodos aleatorios el método del azar simple (*random sampling*) es un método tradicional y particularmente útil desde un punto de vista pedagógico para comenzar ya que muchos otros métodos son variaciones (usualmente más complejas) de este. El método del azar simple es el que intuitivamente se ha utilizado en la simulación anterior.

Desde una perspectiva amplia, en la actualidad se podría afirmar que este método de muestreo se encuentra en el medio de un continuo de situaciones en cuando al grado de información exigida para su realización. Lo "único" que pide es una lista de "contactos" de la población que se quiere analizar. La razón por la que "único" se encuentra entre comillas es la siguiente: La necesidad de la una lista puede ser algo exigente en algunas investigaciones (p.e. poblaciones invisibles) aunque algo insuficiente para otras (p.e. diseños con muestras estratificadas). La idea de "contacto" es algo polisémica pero aquí apunta a que el caso seleccionado se pueda contactar de alguna forma (p.e. dirección de domicilio, mail, celular, etc.) para realizarle las observaciones/mediciones correspondientes.[^azar-2]

A continuación vamos a realizar unas 1000 muestras de 300 casos cada una sobre un total de 4168 escuelas. Esto es una relación entre el tamaño de la población y la muestra de casi el 14%. Hacemos esta cantidad de muestras para observar la distribución de los valores de las medias de cada muestras y ver si sucede algo similar a lo encontrado en el simulador anterior. Para facilitar la comparación lo haremos sólo con las variables numéricas y dejaremos de lado las categóricas como Ámbito y Región. Esto se puede observar en la @tbl-medias_muestrales_azar_simple.

```{r}
#| label: azar_simple_rep

set.seed(123) 

muestras_azar_simple = base_toy |>
rep_slice_sample(n = 300,
                 replace = FALSE,
                 reps = 1000)  

```

```{r}
#| label: tbl-medias_muestrales_azar_simple
#| tbl-cap: Medias de las medias muestrales

tbl_medias_muestrales = muestras_azar_simple |>
group_by(replicate) |>
summarise(matricula = mean(matricula, na.rm = TRUE),
          secciones = mean(secciones, na.rm = TRUE),
          sondeo_primero = mean(sondeo_primero, na.rm = TRUE),
          sondeo_segundo = mean(sondeo_segundo, na.rm = TRUE)) |>
tbl_summary(include = !replicate,
            statistic = list(
      all_continuous() ~ "{mean} ({p25}, {p75})"))

tbl_medias_muestrales
```

Como se puede comparar entre @tbl-parametros_base y @tbl-medias_muestrales_azar_simple los valores entre los parámetros poblacionales y la media de las estimaciones muestrales coincide. No sólo eso. También podemos chequear que la distribución de esas medias sigue una distribución aproximadamente normal. Esto es lo que precisamente hacemos en la @fig-medias_muestrales_azar_simple .

```{r}
#| label: fig-medias_muestrales_azar_simple
#| fig-cap: Distribución de las medias muestrales

fig_medias_muestrales_matricula = muestras_azar_simple |>
group_by(replicate) |>
summarise(matricula = mean(matricula, na.rm = TRUE)) |>
ggplot(aes(matricula)) +
geom_histogram() + 
xlab("Matrícula") +
ylab("Cantidad de muestras")

fig_medias_muestrales_secciones = muestras_azar_simple |>
group_by(replicate) |>
summarise(secciones = mean(secciones, na.rm = TRUE)) |>
ggplot(aes(secciones)) +
geom_histogram() + 
xlab("Secciones") +
ylab("Cantidad de muestras")

fig_medias_muestrales_sondeo_primero = muestras_azar_simple |>
group_by(replicate) |>
summarise(sondeo_primero = mean(sondeo_primero, na.rm = TRUE)) |>
ggplot(aes(sondeo_primero)) +
geom_histogram() + 
xlab("Primer Sondeo") +
ylab("Cantidad de muestras")

fig_medias_muestrales_sondeo_segundo = muestras_azar_simple |>
group_by(replicate) |>
summarise(sondeo_segundo = mean(sondeo_segundo, na.rm = TRUE)) |>
ggplot(aes(sondeo_segundo)) +
geom_histogram() + 
xlab("Segundo Sondeo") +
ylab("Cantidad de muestras")


fig_medias_muestrales_matricula +
fig_medias_muestrales_secciones +
fig_medias_muestrales_sondeo_primero +
fig_medias_muestrales_sondeo_segundo
```

En esta figura se observa que la distribución de las 1000 muestras que tomamos si bien se aproximan tampoco son idénticas a una distribución normal. Seguramente, si haríamos más muestras nos acercaríamos aún más a una distribución muestral pero quizá este ejemplo baste para explicitar el siguiente punto. Si haríamos muchas muestras vamos a saber con cierta seguridad que la media de las muestras será aproximadamente similar al parámetro poblacional pero ¿Qué sucede si sólo tomamos una sola muestra? ¿Cómo sabemos si nuestra (única) muestra es de las buenas o de las malas? ¿Cómo sabemos que nuestra muestra no es alguna de las que están más a la izquierda o más a la derecha en la @fig-medias_muestrales_azar_simple ?

Ahí es donde entra la ayuda de las librerías específicas. En la sección XXX se había comentado sobre la existencia de librerías específicas para el análisis

Aun cuando sea con azar simple es importante aclarar algunas cuestiones. El tipo de muestras que nos interesan generalmente son "sin reemplazo" en el sentido que no queremos que, por ejemplo, un mismo colegio aparezca dos veces en la muestra...al menos si queremos hacer una muestra de colegios y no de estudiantes.

```{r}
#| label: azar_simple

set.seed(123) 

# fpc = ((N-n)/(N-1))1/2



muestra_azar_simple = base |>
slice_sample(n = 300, replace = FALSE)

n = nrow(muestra_azar_simple)
N = nrow(base)

muestra_azar_simple = muestra_azar_simple |>
mutate(pw = N/n,
       fpc = ((N-n)/(N-1))^(1/2))

muestra_azar_simple_sv = muestra_azar_simple |>
as_survey_design(ids = 1,
                 weights = pw,
                 fpc = fpc )
```

```{r}
#| label: tbl-azar_simple
#| tbl-cap: Estimaciones con azar simple

library(cardx)

tbl_azar_simple = muestra_azar_simple_sv |>
tbl_svysummary(include = c(matricula, secciones, sondeo_primero, sondeo_segundo, region, ambito),
               statistic = list(all_continuous() ~ "{mean} ({mean.std.error})",
                                all_categorical() ~ "{n} {n_unweighted} ({p}%) {p.std.error}"))

tbl_azar_simple



```

```{r}
library(PracTools)

ceiling(nPropMoe(moe.sw = 1, 
                 e = seq(0.01,0.08,0.01), 
                 alpha = 0.05, 
                 pU = 0.5))
```

## Muestreo sistemático

```{r}
start <- sample(1:10, size = 1)
m_azar_sistematico_100 = base |>
  slice(seq(start, n(), by = ))
```

[^azar-1]: Si el conjunto de los estudiantes de la provincia hubiera sido sorteado para ingresar a cualquier colegio de la provincia, realizar una muestra aleatoria de colegios con el objetivo de realizar una muestra aleatoria de estudiantes no sería un mayor problema.

[^azar-2]: Más adelante veremos que el muestreo sistemático puede realizarse aún sin la presencia de una "lista" previa a la cual tengan acceso los diseñadores de la muestra aunque sí los que finalmente la ejecuten. En efecto, es compatible con reglas del tipo "Una vez con los potenciales casos a disposición, eliga al primer caso, deje pasar 5 casos y seleccione al siguiente, vuelva a dejar 5 casos y elija al siguiente hasta llegar a seleccionar x cantidad de casos ".
